variables:
  CI_DISPOSABLE_ENVIRONMENT: "true"
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375
  DOCKER_TLS_CERTDIR: ""

.base:
  image: rust:1.70
  tags:
    - cloud
  retry:
    max: 2
    when:
      - runner_system_failure
      - unknown_failure
      - stuck_or_timeout_failure

.docker:
  extends: .base
  before_script:
    - curl -fsSL https://get.docker.com -o get-docker.sh
    - sh get-docker.sh
  tags:
    - k8s-docker
  services:
    - docker:20.10.12-dind

fmt:
  extends: .base
  script:
    - rustup component add rustfmt
    - cargo fmt --check

clippy:
  extends: .base
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

build:
  extends: .base
  script:
    - cargo build
    - apt update
    - apt install -y libudev-dev
    - cargo build --features serial

test_wollet:
  extends: .base
  script:
    - ./download_bins.sh
    - . .envrc
    - cargo test -p wollet -p software_signer

test_jade:
  extends: .docker
  script:
    - docker pull xenoky/local-jade-emulator:latest
    - docker pull tulipan81/blind_pin_server:v0.0.3
    - cargo test -p jade

test_jrpc:
  extends: .base
  script:
    - cargo test -p tiny_jrpc

audit:
  extends: .base
  script:
    - cargo install cargo-audit
    - cargo audit -D warnings
